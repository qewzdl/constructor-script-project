{{ $questions := .ForumQuestions }}
{{ $search := trim (default "" .ForumSearch) }}
{{ $total := or .ForumTotal 0 }}
{{ $page := .ForumPage }}
{{ $forumPath := default "/forum" .ForumPath }}
{{ $categories := .ForumCategories }}
{{ $categoryFilters := .ForumCategoryFilters }}
{{ $loginURL := printf "/login?redirect=%s" (urlquery $forumPath) }}
<section
    class="forum"
    data-forum="list"
    data-login-url="{{ $loginURL }}"
    {{- with index .ForumEndpoints "Create" }}
    data-endpoint-create="{{ . }}"
    {{- end }}
>
    <div class="forum__container">
        <header class="forum__header">
            <div class="forum__heading">
                <h1 class="forum__title">Community forum</h1>
                <p class="forum__subtitle">
                    Start topics, share knowledge, and collaborate with fellow builders across the community.
                </p>
            </div>
            <form class="forum__search" action="/forum" method="get" role="search" aria-label="Forum search">
                <label class="forum__search-label" for="forum-search-input">Search discussions</label>
                <div class="forum__search-controls">
                    <input
                    id="forum-search-input"
                    class="forum__search-input"
                    type="search"
                    name="search"
                    value="{{ $search }}"
                    placeholder="Find topics, keywords, or authors"
                    autocapitalize="sentences"
                />
                <button type="submit" class="forum__search-button">Search</button>
            </div>
        </form>
        </header>

        <div class="forum__toolbar">
            <dl class="forum__stats">
                <div class="forum__stat">
                    <dt class="forum__stat-label">Topics</dt>
                    <dd class="forum__stat-value" data-role="forum-total">{{ $total }}</dd>
                </div>
                {{ with $page }}
                <div class="forum__stat">
                    <dt class="forum__stat-label">Page</dt>
                    <dd class="forum__stat-value">{{ .Current }} / {{ .TotalPages }}</dd>
                </div>
                {{ end }}
            </dl>
            {{ if not .IsAuthenticated }}
            <a class="forum__cta forum__cta--ghost" href="{{ $loginURL }}">Sign in to start a topic</a>
            {{ end }}
        </div>

        {{ if .IsAuthenticated }}
        <div
            class="forum-topic-modal"
            data-role="topic-modal"
            hidden
            aria-hidden="true"
        >
            <div
                class="forum-topic-modal__dialog"
                role="dialog"
                aria-modal="true"
                aria-labelledby="forum-topic-modal-title"
            >
                <button
                    type="button"
                    class="forum-topic-modal__close"
                    data-role="topic-modal-close"
                    aria-label="Close topic form"
                ></button>
                <form
                    id="forum-topic-form"
                    class="forum__form"
                    novalidate
                    data-role="topic-form"
                >
                    <h2 class="forum__form-title" id="forum-topic-modal-title">
                        Start a new discussion
                    </h2>
                    <p class="forum__form-hint">
                        Keep titles specific and include any context in the description so others can help quickly.
                    </p>
                    <div class="forum__alert" data-role="forum-alert" role="status" hidden></div>
                    <label class="forum__label" for="forum-topic-title">
                        Title
                        <input
                            id="forum-topic-title"
                            class="forum__input"
                            type="text"
                            name="title"
                            placeholder="What would you like to learn?"
                            maxlength="160"
                            required
                        />
                    </label>
                    <label class="forum__label" for="forum-topic-content">
                        Description
                        <textarea
                            id="forum-topic-content"
                            class="forum__textarea"
                            name="content"
                            rows="5"
                            placeholder="Share background details, what you have tried, and what you are hoping to accomplish."
                            required
                        ></textarea>
                    </label>
                    {{ if gt (len $categories) 0 }}
                    <label class="forum__label" for="forum-topic-category">
                        Category
                        <select
                            id="forum-topic-category"
                            class="forum__input"
                            name="category_id"
                            data-role="topic-category"
                        >
                            <option value="">No category</option>
                            {{ range $categories }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </label>
                    {{ end }}
                    <div class="forum__form-actions">
                        <button type="submit" class="forum__submit">Post topic</button>
                        <button type="reset" class="forum__reset">Clear</button>
                    </div>
                </form>
            </div>
        </div>
        {{ else }}
        <p class="forum__signin">
            Want to start a topic? <a href="{{ $loginURL }}">Sign in</a> or
            <a href="/register?redirect={{ urlquery $forumPath }}">create an account</a> to start a new thread.
        </p>
        {{ end }}

        <section class="forum__list" aria-live="polite" aria-busy="false">
            <div class="forum__filter-bar">
                {{ if gt (len $categoryFilters) 0 }}
                {{ $activeFilterName := default "All discussions" .ForumActiveCategoryName }}
                <div class="forum__filter-dropdown" data-role="forum-filter">
                    <button
                        class="forum__filter-toggle"
                        type="button"
                        data-role="forum-filter-toggle"
                        aria-haspopup="listbox"
                        aria-expanded="false"
                    >
                        <span class="forum__filter-toggle-label">Category</span>
                        <span class="forum__filter-toggle-value" data-role="forum-filter-value">
                            {{ $activeFilterName }}
                        </span>
                    </button>
                    <div class="forum__filter-menu" role="listbox" data-role="forum-filter-menu" hidden>
                        {{ range $categoryFilters }}
                        {{ $isActive := .Active }}
                        <a
                            class="forum__filter-option{{ if $isActive }} is-active{{ end }}"
                            role="option"
                            href="{{ .URL }}"
                            {{- if $isActive }} aria-selected="true"{{ end }}
                        >
                            {{ .Name }}
                        </a>
                        {{ end }}
                    </div>
                </div>
                {{ end }}

                {{ if gt (len .ForumStatusFilters) 0 }}
                {{ $activeStatusName := default "All statuses" .ForumActiveStatusName }}
                <div class="forum__filter-dropdown" data-role="forum-filter">
                    <button
                        class="forum__filter-toggle"
                        type="button"
                        data-role="forum-filter-toggle"
                        aria-haspopup="listbox"
                        aria-expanded="false"
                    >
                        <span class="forum__filter-toggle-label">Status</span>
                        <span class="forum__filter-toggle-value" data-role="forum-filter-value">
                            {{ $activeStatusName }}
                        </span>
                    </button>
                    <div class="forum__filter-menu" role="listbox" data-role="forum-filter-menu" hidden>
                        {{ range .ForumStatusFilters }}
                        {{ $isActive := .Active }}
                        <a
                            class="forum__filter-option{{ if $isActive }} is-active{{ end }}"
                            role="option"
                            href="{{ .URL }}"
                            {{- if $isActive }} aria-selected="true"{{ end }}
                        >
                            {{ .Name }}
                        </a>
                        {{ end }}
                    </div>
                </div>
                {{ end }}
            </div>
            <p class="forum__empty" data-role="forum-empty" {{ if gt (len $questions) 0 }}hidden{{ end }}>
                No discussions yet. Be the first to start a topic.
            </p>
            <div
                class="forum__table-wrapper"
                data-role="forum-table-wrapper"
                {{ if not (gt (len $questions) 0) }}hidden{{ end }}
            >
                <table class="forum-table">
                    <caption class="visually-hidden">Community forum topics</caption>
                    <thead class="forum-table__header">
                        <tr>
                            <th scope="col" class="forum-table__heading forum-table__heading--topic">
                                Topic
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--avatar" aria-label="Author avatar"></th>
                            <th scope="col" class="forum-table__heading forum-table__heading--numeric">
                                Votes
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--numeric">
                                Answers
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--numeric">
                                Views
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--updated">
                                Updated
                            </th>
                        </tr>
                    </thead>
                    <tbody class="forum-table__body" data-role="forum-list">
                        {{ range $questions }}
                        {{ $slug := .Slug }}
                        {{ if eq $slug "" }}
                            {{ $slug = printf "%d" .ID }}
                        {{ end }}
                        {{ $answers := .AnswersCount }}
                        {{ $author := trim .Author.Username }}
                        {{ $avatar := trim .Author.Avatar }}
                        {{ $updatedAt := .UpdatedAt }}
                        <tr
                            class="forum-table__row"
                            data-topic-id="{{ .ID }}"
                            data-topic-slug="{{ $slug }}"
                            data-topic-url="/forum/{{ $slug }}"
                            role="link"
                            tabindex="0"
                            aria-label="View discussion: {{ .Title }}"
                        >
                            <th
                                scope="row"
                            class="forum-table__cell forum-table__cell--topic"
                            data-label="Topic"
                        >
                            <a class="forum-table__title" href="/forum/{{ $slug }}">{{ .Title }}</a>
                        </th>
                            <td class="forum-table__cell forum-table__cell--avatar" data-label="Author">
                                {{ if $avatar }}
                                <img
                                    src="{{ $avatar }}"
                                    alt="{{ if $author }}{{ $author }}{{ else }}Author{{ end }} avatar"
                                    class="forum-table__avatar"
                                    loading="lazy"
                                />
                                {{ else if $author }}
                                <span
                                    class="forum-table__avatar forum-table__avatar--placeholder"
                                    aria-hidden="true"
                                >
                                    {{ index $author 0 }}
                                </span>
                                {{ else }}
                                <span
                                    class="forum-table__avatar forum-table__avatar--placeholder"
                                    aria-hidden="true"
                                >
                                    ?
                                </span>
                                {{ end }}
                            </td>
                            <td class="forum-table__cell forum-table__cell--numeric" data-label="Votes">
                                <span class="forum-table__numeric">{{ .Rating }}</span>
                            </td>
                            <td
                                class="forum-table__cell forum-table__cell--numeric"
                                data-label="Answers"
                            >
                                <span class="forum-table__numeric">{{ $answers }}</span>
                            </td>
                            <td
                                class="forum-table__cell forum-table__cell--numeric"
                                data-label="Views"
                            >
                                <span class="forum-table__numeric">{{ .Views }}</span>
                            </td>
                            <td
                                class="forum-table__cell forum-table__cell--updated"
                                data-label="Updated"
                            >
                                {{ with $updatedAt }}
                                <time
                                    class="forum-table__updated"
                                    datetime="{{ .Format "2006-01-02T15:04:05Z07:00" }}"
                                >
                                    {{ timeAgo . }}
                                </time>
                                {{ else }}
                                <span class="forum-table__updated">â€”</span>
                                {{ end }}
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </section>

        {{ if .IsAuthenticated }}
        <div class="forum__ask">
            <p class="forum__ask-text">
                Can't find what you're looking for?
                <button
                    type="button"
                    class="forum__ask-trigger"
                    data-role="topic-modal-open"
                    aria-haspopup="dialog"
                >
                    Start a new discussion
                </button>
            </p>
        </div>
        {{ end }}

        {{ with .Pagination }}
        <div class="forum__pagination">
            {{ template "components/pagination" . }}
        </div>
        {{ end }}
    </div>
</section>
