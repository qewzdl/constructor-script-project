{{ $questions := .ForumQuestions }}
{{ $search := trim (default "" .ForumSearch) }}
{{ $total := or .ForumTotal 0 }}
{{ $page := .ForumPage }}
{{ $forumPath := default "/forum" .ForumPath }}
{{ $categories := .ForumCategories }}
{{ $categoryFilters := .ForumCategoryFilters }}
{{ $loginURL := printf "/login?redirect=%s" (urlquery $forumPath) }}
<section
    class="forum"
    data-forum="list"
    data-login-url="{{ $loginURL }}"
    {{- with index .ForumEndpoints "Create" }}
    data-endpoint-create="{{ . }}"
    {{- end }}
>
    <div class="forum__container">
        <header class="forum__header">
            <div class="forum__heading">
                <h1 class="forum__title">Community forum</h1>
                <p class="forum__subtitle">
                    Ask questions, share knowledge, and collaborate with fellow builders across the community.
                </p>
            </div>
            <form class="forum__search" action="/forum" method="get" role="search" aria-label="Forum search">
                <label class="forum__search-label" for="forum-search-input">Search discussions</label>
                <div class="forum__search-controls">
                    <input
                    id="forum-search-input"
                    class="forum__search-input"
                    type="search"
                    name="search"
                    value="{{ $search }}"
                    placeholder="Find topics, keywords, or authors"
                    autocapitalize="sentences"
                />
                <button type="submit" class="forum__search-button">Search</button>
            </div>
        </form>
        </header>

        <div class="forum__toolbar">
            <dl class="forum__stats">
                <div class="forum__stat">
                    <dt class="forum__stat-label">Questions</dt>
                    <dd class="forum__stat-value" data-role="forum-total">{{ $total }}</dd>
                </div>
                {{ with $page }}
                <div class="forum__stat">
                    <dt class="forum__stat-label">Page</dt>
                    <dd class="forum__stat-value">{{ .Current }} / {{ .TotalPages }}</dd>
                </div>
                {{ end }}
            </dl>
            {{ if not .IsAuthenticated }}
            <a class="forum__cta forum__cta--ghost" href="{{ $loginURL }}">Sign in to ask</a>
            {{ end }}
            {{ if gt (len $categoryFilters) 0 }}
            {{ $activeFilterName := default "All discussions" .ForumActiveCategoryName }}
            <div class="forum__filter-dropdown" data-role="forum-filter">
                <button
                    class="forum__filter-toggle"
                    type="button"
                    data-role="forum-filter-toggle"
                    aria-haspopup="listbox"
                    aria-expanded="false"
                >
                    <span class="forum__filter-toggle-label">Category</span>
                    <span class="forum__filter-toggle-value" data-role="forum-filter-value">
                        {{ $activeFilterName }}
                    </span>
                </button>
                <div class="forum__filter-menu" role="listbox" data-role="forum-filter-menu" hidden>
                    {{ range $categoryFilters }}
                    {{ $isActive := .Active }}
                    <a
                        class="forum__filter-option{{ if $isActive }} is-active{{ end }}"
                        role="option"
                        href="{{ .URL }}"
                        {{- if $isActive }} aria-selected="true"{{ end }}
                    >
                        {{ .Name }}
                    </a>
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>

        {{ if .IsAuthenticated }}
        <div
            class="forum-question-modal"
            data-role="question-modal"
            hidden
            aria-hidden="true"
        >
            <div
                class="forum-question-modal__dialog"
                role="dialog"
                aria-modal="true"
                aria-labelledby="forum-question-modal-title"
            >
                <button
                    type="button"
                    class="forum-question-modal__close"
                    data-role="question-modal-close"
                    aria-label="Close question form"
                ></button>
                <form
                    id="forum-question-form"
                    class="forum__form"
                    novalidate
                    data-role="question-form"
                >
                    <h2 class="forum__form-title" id="forum-question-modal-title">
                        Start a new discussion
                    </h2>
                    <p class="forum__form-hint">
                        Keep titles specific and include any context in the description so others can help quickly.
                    </p>
                    <div class="forum__alert" data-role="forum-alert" role="status" hidden></div>
                    <label class="forum__label" for="forum-question-title">
                        Title
                        <input
                            id="forum-question-title"
                            class="forum__input"
                            type="text"
                            name="title"
                            placeholder="What would you like to learn?"
                            maxlength="160"
                            required
                        />
                    </label>
                    <label class="forum__label" for="forum-question-content">
                        Description
                        <textarea
                            id="forum-question-content"
                            class="forum__textarea"
                            name="content"
                            rows="5"
                            placeholder="Share background details, what you have tried, and what you are hoping to accomplish."
                            required
                        ></textarea>
                    </label>
                    {{ if gt (len $categories) 0 }}
                    <label class="forum__label" for="forum-question-category">
                        Category
                        <select
                            id="forum-question-category"
                            class="forum__input"
                            name="category_id"
                            data-role="question-category"
                        >
                            <option value="">No category</option>
                            {{ range $categories }}
                            <option value="{{ .ID }}">{{ .Name }}</option>
                            {{ end }}
                        </select>
                    </label>
                    {{ end }}
                    <div class="forum__form-actions">
                        <button type="submit" class="forum__submit">Post question</button>
                        <button type="reset" class="forum__reset">Clear</button>
                    </div>
                </form>
            </div>
        </div>
        {{ else }}
        <p class="forum__signin">
            Have a question to ask? <a href="{{ $loginURL }}">Sign in</a> or
            <a href="/register?redirect={{ urlquery $forumPath }}">create an account</a> to start a new thread.
        </p>
        {{ end }}

        <section class="forum__list" aria-live="polite" aria-busy="false">
            <p class="forum__empty" data-role="forum-empty" {{ if gt (len $questions) 0 }}hidden{{ end }}>
                No discussions yet. Be the first to ask a question.
            </p>
            <div
                class="forum__table-wrapper"
                data-role="forum-table-wrapper"
                {{ if not (gt (len $questions) 0) }}hidden{{ end }}
            >
                <table class="forum-table">
                    <caption class="visually-hidden">Community forum questions</caption>
                    <thead class="forum-table__header">
                        <tr>
                            <th scope="col" class="forum-table__heading forum-table__heading--question">
                                Question
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--category">
                                Category
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--numeric">
                                Votes
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--numeric">
                                Answers
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--numeric">
                                Views
                            </th>
                            <th scope="col" class="forum-table__heading forum-table__heading--updated">
                                Updated
                            </th>
                        </tr>
                    </thead>
                    <tbody class="forum-table__body" data-role="forum-list">
                        {{ range $questions }}
                        {{ $slug := .Slug }}
                        {{ if eq $slug "" }}
                            {{ $slug = printf "%d" .ID }}
                        {{ end }}
                        {{ $answers := .AnswersCount }}
                        {{ $author := trim .Author.Username }}
                        {{ $updatedAt := .UpdatedAt }}
                        <tr
                            class="forum-table__row"
                            data-question-id="{{ .ID }}"
                            data-question-slug="{{ $slug }}"
                            data-question-url="/forum/{{ $slug }}"
                            role="link"
                            tabindex="0"
                            aria-label="View discussion: {{ .Title }}"
                        >
                            <th
                                scope="row"
                                class="forum-table__cell forum-table__cell--question"
                                data-label="Question"
                            >
                                <a class="forum-table__title" href="/forum/{{ $slug }}">{{ .Title }}</a>
                                <p class="forum-table__excerpt">{{ truncate (trim .Content) 200 }}</p>
                                <div class="forum-table__meta">
                                    <span class="forum-table__meta-item">
                                        {{ if $author }}Asked by {{ $author }}{{ else }}Asked by Community member{{ end }}
                                    </span>
                                    {{ with $updatedAt }}
                                    <time
                                        class="forum-table__meta-item"
                                        datetime="{{ .Format "2006-01-02T15:04:05Z07:00" }}"
                                    >
                                        Updated {{ timeAgo . }}
                                    </time>
                                    {{ end }}
                                </div>
                            </th>
                            <td
                                class="forum-table__cell forum-table__cell--category"
                                data-label="Category"
                            >
                                {{ with .Category }}
                                <span class="forum-table__category">{{ .Name }}</span>
                                {{ else }}
                                <span class="forum-table__category forum-table__category--empty">No category</span>
                                {{ end }}
                            </td>
                            <td
                                class="forum-table__cell forum-table__cell--numeric"
                                data-label="Votes"
                            >
                                <span class="forum-table__numeric">{{ .Rating }}</span>
                            </td>
                            <td
                                class="forum-table__cell forum-table__cell--numeric"
                                data-label="Answers"
                            >
                                <span class="forum-table__numeric">{{ $answers }}</span>
                            </td>
                            <td
                                class="forum-table__cell forum-table__cell--numeric"
                                data-label="Views"
                            >
                                <span class="forum-table__numeric">{{ .Views }}</span>
                            </td>
                            <td
                                class="forum-table__cell forum-table__cell--updated"
                                data-label="Updated"
                            >
                                {{ with $updatedAt }}
                                <time
                                    class="forum-table__updated"
                                    datetime="{{ .Format "2006-01-02T15:04:05Z07:00" }}"
                                >
                                    {{ timeAgo . }}
                                </time>
                                {{ else }}
                                <span class="forum-table__updated">â€”</span>
                                {{ end }}
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </section>

        {{ if .IsAuthenticated }}
        <div class="forum__ask">
            <p class="forum__ask-text">
                Can't find what you're looking for?
                <button
                    type="button"
                    class="forum__ask-trigger"
                    data-role="question-modal-open"
                    aria-haspopup="dialog"
                >
                    Start a new discussion
                </button>
            </p>
        </div>
        {{ end }}

        {{ with .Pagination }}
        <div class="forum__pagination">
            {{ template "components/pagination" . }}
        </div>
        {{ end }}
    </div>
</section>
