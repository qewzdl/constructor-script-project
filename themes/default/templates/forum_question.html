{{ $question := .Question }}
{{ $answers := $question.Answers }}
{{ $answerCount := or .ForumAnswerCount (len $answers) }}
{{ $currentUser := .CurrentUser }}
{{ $canManageAllAnswers := .ForumCanManageAllAnswers }}
{{ $forumPath := default "/forum" .ForumPath }}
<section
    class="forum-topic"
    data-forum="topic"
    data-topic-id="{{ $question.ID }}"
    data-topic-slug="{{ $question.Slug }}"
    data-forum-path="{{ $forumPath }}"
    data-can-delete="{{ if .ForumQuestionCanDelete }}true{{ else }}false{{ end }}"
    data-login-url="{{ .ForumLoginURL }}"
    data-answer-count="{{ $answerCount }}"
    data-current-user-id="{{ if .ForumCurrentUserID }}{{ .ForumCurrentUserID }}{{ end }}"
    data-can-manage-all="{{ if $canManageAllAnswers }}true{{ else }}false{{ end }}"
    {{- with index .ForumEndpoints "Question" }}
    data-endpoint-topic="{{ . }}"
    {{- end }}
    {{- with index .ForumEndpoints "QuestionVote" }}
    data-endpoint-topic-vote="{{ . }}"
    {{- end }}
    {{- with index .ForumEndpoints "AnswerCreate" }}
    data-endpoint-answer-create="{{ . }}"
    {{- end }}
    {{- with index .ForumEndpoints "AnswerBase" }}
    data-endpoint-answer-base="{{ . }}"
    {{- end }}
    {{- with index .ForumEndpoints "AnswerVote" }}
    data-endpoint-answer-vote="{{ . }}"
    {{- end }}
>
    <div class="forum-topic__container">
        <nav class="forum-topic__nav" aria-label="Forum navigation">
            <a class="forum-topic__back" href="{{ $forumPath }}">‚Üê Back to all discussions</a>
        </nav>

        <header class="forum-topic__header">
            <div class="forum-topic__heading">
                <h1 class="forum-topic__title">{{ $question.Title }}</h1>
                <div class="forum-topic__meta">
                    {{ with $question.Category }}
                    <span class="forum-topic__meta-item forum-topic__meta-item--category">
                        {{ .Name }}
                    </span>
                    {{ end }}
                    {{ $author := trim $question.Author.Username }}
                    <span class="forum-topic__meta-item">
                        {{ if $author }}Asked by {{ $author }}{{ else }}Asked by Community member{{ end }}
                    </span>
                    <time
                        class="forum-topic__meta-item"
                        datetime='{{ $question.CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}'
                    >
                        Posted on {{ $question.CreatedAt.Format "02 Jan 2006" }}
                    </time>
                    <span class="forum-topic__meta-item" data-role="answer-count">
                        {{ $answerCount }} {{ if eq $answerCount 1 }}answer{{ else }}answers{{ end }}
                    </span>
                    <span class="forum-topic__meta-item">
                        {{ $question.Views }} {{ if eq $question.Views 1 }}view{{ else }}views{{ end }}
                    </span>
                </div>
            </div>
            <div class="forum-topic__votes" data-role="topic-votes">
                <button
                    type="button"
                    class="forum-vote forum-vote--up"
                    data-role="topic-vote"
                    data-value="1"
                    aria-label="Upvote this topic"
                ></button>
                <output class="forum-vote__value" data-role="topic-rating">{{ $question.Rating }}</output>
                <button
                    type="button"
                    class="forum-vote forum-vote--down"
                    data-role="topic-vote"
                    data-value="-1"
                    aria-label="Downvote this topic"
                ></button>
            </div>
        </header>

        {{ if .ForumQuestionCanDelete }}
        <div class="forum-topic__actions">
            <button type="button" class="forum-topic__delete" data-role="topic-delete">
                Delete topic
            </button>
        </div>
        {{ end }}

        <article class="forum-topic__body">
            <div class="forum-topic__content">{{ $question.Content }}</div>
        </article>

        <div class="forum-topic__alert forum__alert" data-role="forum-alert" role="status" hidden></div>

        <section class="forum-answers" aria-labelledby="forum-answers-title">
            <div class="forum-answers__header">
                <h2 id="forum-answers-title" class="forum-answers__title">Answers</h2>
                <p class="forum-answers__subtitle">
                    Share your experience or offer guidance to help the original poster.
                </p>
            </div>
            <p class="forum-answers__empty" data-role="answer-empty" {{ if gt (len $answers) 0 }}hidden{{ end }}>
                No answers yet. Join the conversation with the first response.
            </p>
            <ol class="forum-answers__list" data-role="answer-list">
                {{ range $answers }}
                {{ $canManage := or $canManageAllAnswers (and $currentUser (eq .AuthorID $currentUser.ID)) }}
                <li
                    class="forum-answer"
                    data-answer-id="{{ .ID }}"
                    data-answer-author-id="{{ .AuthorID }}"
                    data-can-manage="{{ if $canManage }}true{{ else }}false{{ end }}"
                >
                    <div class="forum-answer__votes">
                        <button
                            type="button"
                            class="forum-vote forum-vote--up"
                            data-role="answer-vote"
                            data-value="1"
                            aria-label="Upvote this answer"
                        ></button>
                        <output class="forum-vote__value" data-role="answer-rating">{{ .Rating }}</output>
                        <button
                            type="button"
                            class="forum-vote forum-vote--down"
                            data-role="answer-vote"
                            data-value="-1"
                            aria-label="Downvote this answer"
                        ></button>
                    </div>
                    <article class="forum-answer__body">
                        <header class="forum-answer__meta">
                            {{ $answerAuthor := trim .Author.Username }}
                            <span class="forum-answer__meta-item">
                                {{ if $answerAuthor }}Answered by {{ $answerAuthor }}{{ else }}Community member{{ end }}
                            </span>
                            <time
                                class="forum-answer__meta-item"
                                datetime='{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}'
                            >
                                {{ .CreatedAt.Format "02 Jan 2006 15:04" }}
                            </time>
                        </header>
                        <div class="forum-answer__content">{{ .Content }}</div>
                        {{ if $canManage }}
                        <footer class="forum-answer__actions">
                            <button type="button" class="forum-answer__action" data-role="answer-edit">Edit</button>
                            <button
                                type="button"
                                class="forum-answer__action forum-answer__action--danger"
                                data-role="answer-delete"
                            >
                                Delete
                            </button>
                        </footer>
                        {{ end }}
                    </article>
                </li>
                {{ end }}
            </ol>
        </section>

        {{ if .IsAuthenticated }}
        <form class="forum-answer-form" novalidate data-role="answer-form">
            <h3 class="forum-answer-form__title">Share your answer</h3>
            <p class="forum-answer-form__hint">
                Provide as much detail as possible. Answers that include context or code snippets are most helpful.
            </p>
            <label class="forum__label" for="forum-answer-content">
                Your answer
                <textarea
                    id="forum-answer-content"
                    class="forum__textarea"
                    name="content"
                    rows="5"
                    data-role="answer-content"
                    required
                ></textarea>
            </label>
            <div class="forum-answer-form__actions">
                <button type="submit" class="forum__submit" data-role="answer-submit">Post answer</button>
                <button type="button" class="forum__reset" data-role="answer-cancel" hidden>Cancel</button>
            </div>
        </form>
        {{ else }}
        <p class="forum-answer-form__signin">
            Want to contribute? <a href="{{ .ForumLoginURL }}">Sign in</a> or
            <a href="/register?redirect={{ urlquery $forumPath }}">create an account</a> to reply.
        </p>
        {{ end }}
    </div>
</section>
